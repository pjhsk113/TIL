# [Real MySQL 8.0] 인덱스 2/2

## B-Tree 인덱스를 통한 데이터 읽기

어떤 경우에 인덱스를 사용하도록 유도할지, 사용하지 못하게 할지 판단하려면 MySQL이 어떻게 인덱스를 이용해 실제 레코드를 읽어 내는지 알아야 한다. 이제 MySQL이 인덱스를 이용하는 방법 세 가지를 알아보자.



### 인덱스 레인지 스캔

인덱스 레인지 스캔은 가장 대표적인 인덱스 접근 방식으로, 검색해야 할 인덱스의 범위가 결정됐을 때 사용하는 방식이다. 뒤에 설명할 두 가지 인덱스 접근 방식보다는 빠른 방법이다.

다음 쿼리를 예제로 살펴보자.

```sql
SELECT * FROM employees WHERE first.name BETWEEN 'Ebbe' AND 'Gad';
```

위 쿼리가 실행되면 아래 그림과 같이 루트 노드에서부터 브랜치 노드를 거쳐 최종적으로 리프 노드까지 찾아 들어가 필요한 레코드의 시작점을 찾는다. (두꺼운 화살표는 실제 스캔하는 범위)

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/240b5797-9d6e-410f-af6c-3f317ad7ae10/Untitled.png)

시작 지점을 찾으면 그때부터는 리프 노드의 레코드만 차례대로 쭉 읽으면 된다. 만약 리프 노드의 끝까지 읽으면 리프 노드 간 링크를 이용해 다음 리프 노드를 찾아 다시 스캔을 시작한다.

위 그림은 실제 인덱스만 읽는 경우를 나타낸다. 하지만 B-Tree 인덱스의 리프 노드를 스캔하면서 실제 데이터 파일의 레코드를 읽어와야 하는 경우도 많은데, 이 과정을 더 자세히 나타내면 다음과 같다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/36cb78d6-93c0-490c-ab44-58f438f7c082/Untitled.png)

인덱스는 정렬되어있기 때문에 인덱스의 컬럼의 정순 또는 역순으로 레코드를 가져온다. 또한, 리프 노드에서 검색 조건에 일치하는 건들은 데이터 파일에서 레코드를 읽어오는데 이때 **한 건당 랜덤 I/O**가 발생한다.

> 커버링 인덱스
인덱스 키와 레코드 주소를 이용해 레코드가 저장된 페이지를 가져오고 최종 레코드를 읽어오는 과정이 필요없는 인덱스다. 디스크를 읽지 않으므로 랜덤 읽기가 줄어들어 성능이 빨라진다.
>

### 인덱스 풀 스캔

인덱스의 처음부터 끝까지 모두 읽는 방식을 말한다.
대표적으로 쿼리 조건절에 사용된 컬럼이 인덱스의 첫 번째 컬럼이 아닌 경우 인덱스 풀 스캔 방식이 사용된다.

```sql
// (A, B, C)라는 인덱스가 있다고 가정
SELECT * FROM employees WHERE B = 'b' AND C = 'c';

--> 조건절에 사용된 컬럼이 인덱스의 첫 번째(A) 컬럼이 아니므로 인덱스 풀 스캔이 일어난다.
```

인덱스 풀 스캔의 처리 방식을 그림으로 살펴보면 다음과 같다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b88000b7-1d08-41e3-a16a-ab7632e79c77/Untitled.png)

1. 인덱스 리프 노드의 제일 앞 또는 제일 뒤로 이동한다.
2. 해당 위치에서 리프 노드를 연결하는 링크드 리스트를 따라 처음부터 끝까지 스캔한다.

인덱스 풀 스캔은 테이블 전체를 읽는 것보다 적은 디스크 I/O가 발생하기 때문에 테이블 전체를 읽는 것보다는 낫다고 볼 수 있지만 인덱스를 사용하는 측면에서는 효율적인 방식은 아니다. 즉, 인덱스를 효율적으로 사용하지 못하는 것으로 볼 수 있다.

### 루스 인덱스 스캔

MySQL의 루스 인덱스 스캔은 오라클의 **인덱스 스킵 스캔**과 작동 방식이 비슷하다. 루스 인덱스 스캔은 말 그대로 느슨하게 또는 듬성듬성하게 인덱스를 읽는 것을 의미한다.

인덱스 레인지 스캔과 비슷하게 작동하지만 중간에 필요하지 않은 인덱스 키 값은 무시하고 넘어가는 형태로 처리된다. 일반적으로 GROUP BY 또는 MAX(), MIN() 함수에 대해 최적화를 하는 경우 사용한다.

MySQL 5.7 버전까지는 기능이 많이 제한적이었지만, MySQL 8.0 버전부터 최적화를 지원하기 시작했다.

### 인덱스 스킵 스캔