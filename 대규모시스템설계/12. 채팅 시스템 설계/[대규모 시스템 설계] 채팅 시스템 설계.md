# [대규모 시스템 설계] 채팅 시스템 설계

채팅 앱은 우리가 가장 많이 사용하고 있는 서비스 중 하나다.
채팅 앱에는 1:1 채팅이나 그룹 채팅같이 업무 혹은 개인 메시지에 특화된 채팅 시스템이나 게임 등에 특화된 음성 채팅 등이 존재하는데, 이번장에서는 카카오톡이나 페이스북 메신저와 같은 1:1 채팅과 그룹 채팅에 특화된 채팅 앱을 개략적으로 알아본다.

## 개략적인 요구사항

- 응답지연이 낮은 1:1 채팅 기능 제공
- 최대 100명까지 참여할 수 있는 그룹 채팅 기능 제공
- 사용자 접속 상태 표시
- 하나의 계정으로 여러 단말에서 동시 접속 지원
- 푸시 알림

## 채팅의 기본 기능과 프로토콜

채팅 서비스가 갖춰야할 기본 기능은 아래와 같다.

- 클라이언트들로부터 메시지 수신
- 메시지 수신자 결정 및 전달
- 수신자가 접속 상태가 아닌 경우 접속할 때 까지 보관

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/332b8ab3-785b-4f5c-904b-42e7dd641ac0/Untitled.png)

채팅 서비스의 경우 어떤 통신 프로토콜을 사용할 것인지가 굉장히 중요한 요소이다.
위 그림에서는 클라이언트가 채팅 서비스에 HTTP 프로토콜로 연결한 다음 메시지를 보내어 수신자에게 해당 메시지를 전달하라고 알린다.

이때 keep-alive 헤더를 사용해 클라이언트-서버 사이의 연결을 끊지 않고 계속 유지하도록하면 핸드셰이크 횟수를 줄일 수 있어 효율적이다.
하지만 메시지 수신 시나리오는 이것보다 복잡하고 서버에서 클라이언트로 임의 시점에 메시지를 보내는데 쉽게 쓰일 수 없는 문제가 존재한다. 따라서 이를 해결하기 위해 **폴링, 롱 폴링, 웹소켓** 등 다양한 기법들이 제안되어 왔다.

### 폴링

폴링 기법은 클라이언트가 주기적으로 서버에게 새 메시지가 있는지 확인하는 방법이다.
주기적으로 확인하는 방법이기 때문에 서버에서 답해줄 메시지가 없는 경우 서버 자원이 불필요하게 낭비된다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0ffa01f0-d890-4b82-b16a-f22ff49ac5ae/Untitled.png)

### 롱 폴링

롱 폴링은 폴링의 비효율적인 부분을 개선한 기법이다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c13fa183-42b6-4b99-a4b4-489e1cc07514/Untitled.png)

롱 폴링은 주기적으로 새 메시지가 있는지 확인하는 대신 새 메시지가 반환되거나 타임아웃 될 때까지 연결을 유지한다. 새 메시지를 받으면 기존 열결을 종료하고 서버에 새로운 요청을 보내어 모든 절차를 다시 시작한다.

하지만 롱 폴링 또한 단점이 존재하는데, 다음과 같다.

- HTTP 서버들은 일반적으로 무상태 서버이므로 메시지를 보내는 클라이언트와 수신하는 클라이언트가 같은 채팅 서버에 접속하지 않을 수 있다.
  - 로드밸런싱을 위해 라운드 로빈 알고리즘을 사용하는 경우, 메시지를 받은 서버는 해당 메시지를 수신할 클라이언트와의 롱 폴링 연결을 가지고 있지 않은 서버일 수도 있기 때문이다.
- 서버 입장에서는 클라이언트가 연결을 해제했는지 아닌지 알 좋은 방법이 없다.
- 메시지를 많이 받지 않는 클라이언트도 타임아웃이 일어날 때마다 서버에 접속하므로 비효율적이다.

### 웹소켓

웹소켓은 서버가 클라이언트에게 비동기 메시지를 보낼 때 가장 널리 사용하는 기술이다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/8233b2c0-bb54-4737-bff3-ba258606eb22/Untitled.png)

클라이언트가 웹소켓 연결을 시작하고, 한번 맺어진 연결은 양방향으로 이루어진다.
처음에는 HTTP 연결이지만 특정 핸드셰이크 절차를 거치면 웹소켓 연결로 변경된다.
또한, 웹소켓을 사용하면 메시지를 보낼 때나 받을 때 동일한 프로토콜을 사용할 수 있으므로 구현도 단순하고 직관적이다. 따라서 채팅 시스템을 설계할 때 굳이 HTTP 연결을 고집할 필요없이 웹소켓을 사용하면 된다.

## 개략적인 설계안

웹 소켓을 프로토콜로 사용하기로 결정했으니 이제 무상태 서비스, 상태유지 서비스, 제3자 서비스 연동으로 나누어 전체 시스템의 개략적인 설계를 해보자.

### 무상태 서비스

무상태 서비스는 로그인, 회원가입, 사용자 프로필 표시 등을 처리하는 전통적인 요청/응답 서비스로 로드밸런서 뒤에 위치한다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b9b16630-7cd9-4265-8a61-40442a44d66d/Untitled.png)

무상태 서비스들 중 서비스 탐색 서비스는 클라이언트가 접속할 채팅 서버의 DNS 호스트명을 클라이언트에게 알려주는 역할을 한다. 즉, 클라이언트에게 가장 적합한 채팅 서버를 추천해주는 것이다.

### 상태 유지 서비스

채팅 서비스는 각 클라이언트가 채팅 서버와 독립적인 네트워크 연결을 유지해야 한다. 따라서 상태 유지 서비스가 필요하게 된다. 클라이언트는 일반적으로 서버가 살아 있는 한 다른 서버로 연결을 변경하지 않기 때문에 특정 서버에 부하가 몰리지 않도록 서비스 탐색 서비스와 긴밀한 협력을 하게 된다.

### 제3자 서비스 연동

채팅 서비스에서 새 메시지를 받은 경우 푸시 알림은 필수적으로 필요하다. 이는 앱이 실행중이 않더라도 알림을 받아야하므로 채팅 서비스와 푸시 알림 서비스의 통합은 매우 중요하다. 이 부분이 궁금하다면 3장의 알림 시스템 설계를 참고하자.

### 규모 확장성

채팅 서비스가 커지면 대량의 트래픽 처리는 필수적이므로 규모 확장성이 중요한 요소로 작용한다.
계속해서 살펴봤던 규모 확장성의 개념을 도입하면 다음과 같은 구조를 개략적으로 설계할 수 있다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f14a988a-a8f8-46ae-a1d1-24a55e4b33ad/Untitled.png)

실시간으로 메시지를 주고 받기 위해 클라이언트는 채팅 서버와 웹소켓 연결을 끊지 않고 유지한다.

- 채팅 서버는 클라이언트 사이에서 메시지를 중계하는 역할을 담당한다.
- 접속 상태 서버는 사용자의 접속 여부를 관리한다.
- API 서버는 로그인, 회원가입 등 나머지 전부를 처리한다.
- 알림 서버는 푸시 알림을 담당한다.
- 키-값 저장소는 채팅 이력을 보관하고 사용자에게 이전 채팅 이력 정보 제공을 담당한다.

### 저장소

채팅 시스템이 다루는 데이터는 보통 두 가지다.

1. 사용자 프로필, 설정, 친구 목록과 같은 일반적인 데이터
2. 채팅 이력처럼 채팅 시스템에 고유한 데이터

우리는 이 두개의 데이터 유형과 읽기/쓰기 연산 패턴을 이해하고 저장소를 선택해야 한다.

1번의 경우 데이터 안정성을 보장하는 관계형 데이터베이스가 적합하고
2번은 키-값 저장소와 같은 NoSQL이 유리하다.

채팅 이력 데이터의 양은 엄청나게 많고 최근에 주고 받은 메시지가 가장 빈번하게 사용되며, 검색 기능이나 멘션 같은 기능도 잘 지원해야 한다.

키-값 저장소는 수평적 규모 확장이 쉽고, 데이터 접근 지연시간이 낮기 때문에 채팅 이력을 보관하는 저장소로 사용하기에 적합하다.

### 데이터 모델

그렇다면 **키-값 저장소에 저장될 메시지 데이터는 어떻게 보관**해야할까?
메시지의 키가 되는 ID, 메시지를 보내는 사람, 받는 사람, 메시지 컨텐츠, 메시지 생성 일자 등이 필요할 것이다.
여기서는 메시지의 ID가 중요하다.

메시지 ID는 고유해야하며 정렬이 가능해야 한다. 즉, 새로운 ID는 이전 ID보다 큰 값을 가지고 있어야 한다.

가장 적합한 메시지 ID 생성 방법은 몇가지가 있는데, 첫 번째 방법은 7장에서 살펴본 스노플레이크 같은 전역적 64-bit 순서 번호 생성기를 이용하는 것이고 두 번째 방법은 지역적 순서 번호 생성기를 이용하는 것이다.
여기서 지역적 순서 번호 생성기란 같은 그룹 안에서만 유일성을 보증하는 순서 번호 생성기를 말한다.

## 상세 설계

상세 설계에서는 채팅 시스템의 중요한 컴포넌트인 서비스 탐색, 메시지 전달 흐름, 사용자 접속 상태 표시하는 방법을 더 자세히 알아본다.