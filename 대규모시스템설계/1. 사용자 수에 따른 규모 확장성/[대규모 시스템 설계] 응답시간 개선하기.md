# [대규모 시스템 설계] 응답시간 개선하기

앞서 웹 계층과 데이터 계층의 규모에 따른 시스템 설계를 살펴봤으니, 응답시간을 개선하는 방법에 대해 알아보자.

응답시간은 캐시와 콘텐츠 전송 네트워크(CDN)를 이용해 개선할 수 있다.

## 캐시란?

캐시는 비싼 연산이나 자주 조회되는 데이터를 메모리에 올려두는 임시 저장소다.
접근 시간이 오래걸리는 반복 요청이나 값을 다시 계산하는 비용을 줄이고 싶은 경우 유용하다.

웹 서비스는 데이터베이스 호출 빈도에 따라 성능이 크게 좌우되기 때문에 캐시를 잘 활용하면 성능을 유의미하게 올릴 수 있다.

## 캐시 계층

캐시 계층은 데이터가 잠시 보관되는 곳으로 데이터베이스에 접근하는 것보다 훨씬 빠르다.
별도의 캐시 계층을 두면 이미 캐시에 데이터가 보관되어 있다면 성능이 개선될 뿐 아니라 데이터베이스의 부하도 줄일 수 있다.

캐시 계층의 역할은 다음과 같다.

캐시에 원하는 데이터가 있는 경우 DB에 쿼리를 날리지 않고 서버로 데이터를 반환한다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c77ed3b9-d9e8-4f3b-87bc-66b2fce3bcd6/Untitled.png)

없는 경우에는 DB에 쿼리를 날려 데이터를 찾아 캐시에 저장한 다음 데이터를 서버로 반환한다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e4ecb0df-ae60-4e91-b9ab-d7ab8747f71e/Untitled.png)

이러한 캐시 전략을 **주도형 캐시 전략(read-through)**이라고 부른다.
이외에도 cache-aside, write-through, write-behind, refresh-ahead 등 다양한 캐시 전략들이 존재한다.
캐시할 데이터 종류, 크기, 액세스 패턴에 맞는 전략을 적절히 선택하면 된다.

## 캐시 사용 시 고려사항

캐시를 사용할 때는 아래 사항들을 고려해야 한다.

### 캐시가 필요한 상황

데이터 갱신이 자주 일어나지 않지만, 참조가 빈번하게 일어난다면 캐시로 사용이 적합하다.

### **캐시 할 데이터의 속성**

영속적으로 보관할 데이터는 캐시에 적합하지 않다. 캐시 서버가 재시작되면 데이터는 모두 사라지기 때문이다.

### **캐시 데이터의 만료 기간**

만료 기간이 너무 짧으면 데이터베이스를 자주 조회하게되고, 반대로 너무 길다면 원본 데이터와의 차이가 생길 수 있다.

### 일관성

원본 데이터와 캐시 데이터 갱신 연산이 단일 트랜잭션으로 처리되지 않는 경우 데이터의 일관성이 깨질 수 있다. 저장소 내의 원본과 캐시 내의 사본은 항상 일관성을 유지해야한다.

### **장애 대처 방안**

캐시 서버를 한 대만 두는 경우 단일 장애 지점 즉, 특정 지점에서의 장애가 전체 시스템 동작을 중단시켜버릴 수도 있다. 따라서 캐시 서버는 분산해두는 것이 좋다.

### 캐시 메모리의 크기

캐시 메모리가 너무 작으면 데이터가 캐시에서 자주 밀려나므로 성능이 떨어진다. 캐시 메모리는 가능한 크게 잡는 것이 유리하다.

### 데이터 방출 정책

캐시가 꽉 차면 이전 데이터를 내보내야 한다.
이를 데이터 방출 정책이라고 하는데, 가장 널리 쓰이는 것은 **마지막으로 사용된 시점이 가장 오래된 데이터를 방출하는 LRU(Least Recently Used)**이다. 이외에도 **사용 빈도가 가장 낮은 데이터를 방출하는 LFU(Least Frequently Used)나, FIFO(First In First Out)** 같은 정책들이 존재한다.

## 콘텐츠 전송 네트워크(CDN)

CDN은 정적 컨텐츠를 전송하는데 쓰이는, 지리적으로 분산된 서버 네트워크다.
이미지, 비디오, CSS, JS 파일 등을 캐시할 수 있다.

CDN을 활용하면 사이트나 컨텐츠 로딩 시간의 응답 속도를 유의미하게 개선할 수 있다.
사용자가 요청한 지역과 가장 가까운 CDN 서버로부터 정적 컨텐츠를 전송하기 때문이다.

가장 쉬운 예로 넷플릭스, 네이버 웹툰 등 글로벌 컨텐츠 기업들이 CDN을 활용한다고 생각하면 쉽다.
당연하겠지만, 서버로부터 물리적 거리가 멀어지면 로드되는 속도는 당연히 느려진다.
만약 넷플릭스의 동영상이 미국 CDN 서버로부터 전송 된다고하면, 미국에서는 빠른 속도로 동영상이 제공되겠지만 유럽에서는 느리게 제공될 것이다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/95c08e61-e881-491e-9ed2-dd7b4c6bf27f/Untitled.png)

이는 사용자의 서비스 경험으로 이어지기 때문에 서비스에 악영향을 미칠 수 있다. 따라서 각 지역에 CDN 서버를 두고 사용자가 요청한 지역과 가장 가까운 CDN 서버로부터 컨텐츠를 전송받게하는 것이다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/28f74516-6f8a-4e62-a119-098eee640643/Untitled.png)

## CDN의 동작 방식

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/fde03c91-1fd4-47d0-904b-0b4ba16e43bc/Untitled.png)

1. 사용자 A가 이미지 파일을 요청한다.
2. CDN 서버의 캐시에 해당 이미지가 없는 경우, 원본 서버에 요청해 이미지 파일을 가져온다.
3. 원본 서버가 CDN 서버에 이미지 파일을 반환한다. 헤더에는 캐시의 생명주기 정보인 TTL(Time-To-Live) 값이 들어있다.
4. CDN 서버는 전달받은 이미지 파일을 캐시에 저장하고 사용자 A에게 반환한다. 캐시된 이미지 파일은 TTL에 명시된 시간만큼 캐시된다.
5. 사용자 B가 같은 이미지에 대한 요청을 CDN에 전송한다.
6. 만료되지 않은 이미지 파일은 CDN 서버의 캐시를 통해 바로 반환된다.

## CDN 사용 시 고려 사항

### 비용

CDN은 보통 서드파티 사업자에 의해 운영되며, 데이터 전송양에 따라 요금이 부과된다.
자주 사용되지 않는 컨텐츠를 캐싱하는 것은 비효율적이므로 CDN 사용으로 얻을 수 있는 이득을 잘 생각해봐야한다.

### 적절한 만료 시한

time-sensitive가 중요한 컨텐츠의 경우 만료 시점을 잘 정해야한다.
앞서 살펴본 캐시와 마찬가지로 만료 시한이 너무 짧으면  원본 서버에 접속 빈도가 많아져 좋지 않고,
반대로 너무 길다면 컨텐츠의 신선도가 떨어질 수 있다.

### 장애 대처 방안

CDN 서버 자체가 죽었을 경우 서비스에 직접적인 영향이 가지 않도록 시스템을 설계해야 한다.
예를 들어 CDN이 일시적으로 응답하지 않는 경우, 문제를 감지하고 원본 서버로부터 직접 컨텐츠를 전송을 수 있도록 시스템을 구성해야한다.

### 컨텐츠 무효화 방법

만료되지 않은 컨텐츠라도 컨텐츠를 무효화할 수 있는 방법을 고려해야한다.
일반적으로 CDN 서비스에서 제공하는 API를 이용해 컨텐츠를 무효화하거나, 컨텐츠의 다른 버전을 서비스하도록 오브젝트 버저닝을 이용하는 방법이 있다.

## 시스템 구성하기

앞서 살펴본 캐시와 CDN을 추가해서 시스템을 구성해보면 다음과 같다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/8946e4fc-99ba-4740-83b1-2351f43207f3/Untitled.png)

이제 정적 컨텐츠(JS, CSS, 이미지, 동영상 등)는 웹 서버를 통해 서비스하는 것이 아니라 CDN으로부터 제공되어 더 나은 응답 속도를 보장할 수 있게된다. 또한, 캐시를 통해 데이터베이스의 부하를 줄이고 응답 속도를 개선할 수 있다.