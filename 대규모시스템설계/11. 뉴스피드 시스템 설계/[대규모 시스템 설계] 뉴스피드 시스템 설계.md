# [대규모 시스템 설계] 뉴스 피드 시스템 설계

페이스북이나 인스타그램, 트위터같은 SNS들은 사용자 상태 정보나 스토리 업데이트 등 다양한 컨텐츠 정보들을 뉴스 피드 시스템을 통해 쉽고 빠르게 전달한다.

우리는 개발자이므로 수 백 ~ 수 천만의 사용자들의 피드들을 어떻게 안정적으로 발행하고 생성할 것인지에 대해 고민해봐야 한다. 만약 우리가 이런 시스템을 설계한다고 생각했을 때 어떤 부분을 고려해야할까?

우선, 뉴스 피드 시스템의 핵심 기능은 **피드 발행**과 **뉴스 피드 생성**으로 나눌 수 있다.

## 피드 발행

사용자가 스토리를 포스팅하면 해당 데이터를 캐시와 데이터베이스에 기록한다.
이렇게 포스팅된 정보는 친구 목록의 뉴스 피드에 전송되야 한다.
다음은 개략적인 피드 발행 시스템 설계안이다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3452b5c5-47ad-4a87-84e2-8bb6e71127d0/Untitled.png)

- 웹 서버
  - 인증이나 처리율 제한 등의 기능을 수행한다.
- 포스팅 저장 서비스
  - 새 포스팅을 DB와 캐시에 저장하는 서비스
- 포스팅 전송 서비스
  - 새 포스팅을 친구의 뉴스 피드에 푸시하는 서비스
- 알림 서비스
  - 새 포스팅이 올라왔을 때 친구들에게 푸시 알림을 보내는 서비스


포스팅 저장 서비스는 지금까지 다뤘던 시스템 구성 방법들을 기반으로 설계하면 충분할 것이기에, 뉴스 피드 시스템의 포스팅 전송 서비스에 초점을 맞춰 더 알아보자.

### 포스팅 전송 서비스

포스팅 전송은 어떤 사용자의 새 포스팅을 그 사용자와 친구 관계에 있는 모든 사용자에게 전달하는 과정이다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ec885245-d6d5-49bc-90b7-7ab3db1fd5ae/Untitled.png)

포스트 전송 방법에는 두 가지 모델이 있는데 하나는 **쓰기 시점에 포스팅을 전송하는 모델(push 모델)**이고, 다른 하나는 **읽기 시점에 포스팅 전송하는 모델(pull 모델)**이다.

**쓰기 시점에 포스팅 전송하는 모델(Push 모델)**

- 장점
  - 뉴스 피드가 실시간으로 갱신되며 친구 목록에 있는 사용자에게 즉시 전송된다.
  - 포스팅이 쓰여지는 시점에 전송되므로 뉴스 피드를 읽는 데 드는 시간이 짧아진다.
- 단점
  - 친구가 많은 사용자의 경우 뉴스 피드 갱신에 많은 시간이 소요될 수 있다.(핫키 이슈)
  - 사용자의 친구 목록에 있는 사용자의 피드를 모두 갱신하므로 서비스를 자주 이용하지 않는 사용자의 피드까지 갱신된다. 따라서 컴퓨팅 자원이 낭비된다.

**읽기 시점에 포스팅 전송하는 모델(Pull 모델)**

- 장점
  - 로그인하지 않은(비활성화된 사용자) 또는 서비스를 자주 이용하지 않는 사용자에게 피드가 갱신되지 않으므로 컴퓨팅 자원을 아낄 수 있다.
  - 데이터를 친구 목록의 사용자 모두에게 푸시하는 작업이 필요없으므로 핫키 문제도 발생하지 않는다.
- 단점
  - 뉴스 피드를 읽는데 많은 시간이 소요될 수 있다.


가장 좋은 설계 방법은 이 두 가지 모델의 장점을 결합해 사용하는 것이다.

뉴스 피드를 가져오는 작업에는 대부분의 사용자에게 Push 모델을 적용하고 핫키가 발생할 수 있는 유명인의 경우 Pull 모델을 적용해 시스템 부하를 방지한다. 또한, 안정 해시를 통해 요청과 데이터를 보다 고르게 분산시켜 핫키 이슈를 자체를 줄이는 방법도 있다.

## 뉴스 피드 생성

새로운 포스팅이 발생하면 친구들의 뉴스 피드에 포스팅이 조회되어야 한다.
일반적으로 모든 친구의 포스팅을 시간 흐름 역순으로 모아 만든다.
피드 읽기 흐름을 간략히 나타내면 다음과 같다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c439ea7c-7679-4134-97c3-a9f4a99267a7/Untitled.png)

- 뉴스 피드 서비스
  - 캐시에서 뉴스 피드를 가져오는 서비스
- 뉴스 피드 캐시
  - 뉴스 피드를 렌더링할 때 필요한 피드 ID를 보관한다.


개략적으로 설계한 설계를 더 구체화 시켜보자.****