# [대규모 시스템 설계] 처리율 제한 장치

처리율 제한 장치는 클라이언트 또는 서비스가 보내는 트래픽의 처리율을 제어하는 장치이다.
HTTP를 예로 들면 특정 기간 내에 전송되는 클라이언트의 요청 횟수를 제한하는 식이다.
API 요청 횟수가 임계치를 넘어서면 이후 모든 호출은 중단된다.

구체적인 사례를 보면 다음과 같다.

- 사용자는 초당 2회 이상 새 글을 올릴 수 없다.
- 같은 IP로 하루에 10개 이상의 계정을 생성할 수 없다.
- 같은 디바이로 주 5회 이상 리워드를 요청할 수 없다.

거의 대부분의 대형 IT 서비스 기업들은 처리율 제한 장치를 가지고 있다.
그렇다면 처리율 제한 장치를 둠으로써 얻는 이점은 어떤것들이 있을까?

크게 3가지의 이점을 말할 수 있다.

1. DoS 공격에 의한 서버 자원 고갈을 방지할 수 있다.
2. 비용을 절감할 수 있다.
3. 서버 과부하를 방지할 수 있다.

단일 호스트로부터 들어오는 DoS 공격을 방지할 수 있고, 요청 제한을 통해 서드 파티 API 호출 비용을 절감할 수 있으며, 봇이나 잘못된 이용 패턴으로 발생하는 트래픽을 걸러내므로 서버 과부하를 방지할 수 있다.

## 처리율 제한 장치 구축 위치

직관적으로 보자면 처리율 제한 장치는 **클라이언트 측**에 둘 수도 있고, **서버 측**에 둘 수도 있다.

클라이언트의 요청은 쉽게 위변조가 가능하다.
해당 클라이언트의 구현을 통제하는 것을 고려해볼 수 있지만, 일반적으로 클라이언트는 서버와 N:1의 관계를 가지기 때문에 모든 클라이언트의 구현을 통제하는 것이 어려울 수 있다.

그렇기 때문에 처리율 제한 장치를 **클라이언트 측에 두는 것은 적절하지 않다.**

우리는 API 서버 측에 제한 장치를 두는 방법을 선택할 수 있지만, 다른 방법도 있다.
바로 **처리율 제한 미들웨어**를 만들어 클라이언트와 서버 사이에 두고 API 서버로 가는 요청을 통제하도록 하는 것이다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/96883df8-aba7-40fd-9a61-621c08754ca7/Untitled.png)

처리율 제한 미들웨어는 정해진 규칙에 의해 API 요청 횟수가 임계치를 넘어서면 이후 HTTP Status Code 429를 반환한다.

마이크로서비스의 경우 API 게이트웨이에 처리율 제한 장치를 구축한다.
API 게이트웨이는 처리율 제한, SSL 종단, 사용자 인증, IP 허용 목록 관리 등을 지원한다.

## 처리율 제한 알고리즘

처리율 제한을 실현하는 알고리즘에는 어떤 것들이 있고 각각 어떤 장단점을 가지고 있는지 개략적으로 알아보자.

### 토큰 버킷 알고리즘

토큰 버킷 알고리즘은 간단하고 이해하기 쉬운 처리율 제한 알고리즘이다.
동작방식도 간단하다.

토큰 버킷은 지정된 용량을 갖는 컨테이너다.
이 버킷에는 사전에 설정된 개수만큼의 토큰이 주기적으로 채워진다.
버킷이 가득 차면 추가로 공급된 토큰은 버려진다.